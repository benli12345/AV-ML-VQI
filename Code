#R version 4.3.1.
#Load VQI AV_ACCESS data (available with approval through SVS PSO https://www.vqi.org/data-analysis/)
library(readr)
data <- read_csv("av_data.csv")

#Split data into train (70%) and test (30%) sets
library(caTools)
set.seed(123)
sample <- sample.split(data$ACCESS_USED, SplitRatio = 0.7)
train <- subset(data, sample == TRUE)
test <- subset(data, sample == FALSE)

#Apply Random Over-Sample Examples (ROSE) for class balance on training set
library(ROSE)
train <- ROSE(ACCESS_USED ~ ., data = train, N = 59674, seed = 123)$data

#Define predictors
library(dplyr)

predictors_train_preop <- train %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

predictors_test_preop <- test %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

predictors_train_intraop <- train %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW, ABX, ABX_START, ABX_STOP, ANESTHESIA, TARGET_ARTERY_DIAMETER, TARGET_VEIN_DIAMETER, CCPROC_0, CCPROC_1, CCPROC_2, CCPROC_3, CCPROC_4, CCPROC_5, CCPROC_6, CCPROC_7, CCPROC_8, CCPROC_9, CCPROC_10, CCPROC_99, R_COMPLETION_STUDY_0, R_COMPLETION_STUDY_1, R_COMPLETION_STUDY_2, R_COMPLETION_STUDY_3)

predictors_test_intraop <- test %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW, ABX, ABX_START, ABX_STOP, ANESTHESIA, TARGET_ARTERY_DIAMETER, TARGET_VEIN_DIAMETER, CCPROC_0, CCPROC_1, CCPROC_2, CCPROC_3, CCPROC_4, CCPROC_5, CCPROC_6, CCPROC_7, CCPROC_8, CCPROC_9, CCPROC_10, CCPROC_99, R_COMPLETION_STUDY_0, R_COMPLETION_STUDY_1, R_COMPLETION_STUDY_2, R_COMPLETION_STUDY_3)

predictors_train_postop <- train %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW, ABX, ABX_START, ABX_STOP, ANESTHESIA, TARGET_ARTERY_DIAMETER, TARGET_VEIN_DIAMETER, CCPROC_0, CCPROC_1, CCPROC_2, CCPROC_3, CCPROC_4, CCPROC_5, CCPROC_6, CCPROC_7, CCPROC_8, CCPROC_9, CCPROC_10, CCPROC_99, R_COMPLETION_STUDY_0, R_COMPLETION_STUDY_1, R_COMPLETION_STUDY_2, R_COMPLETION_STUDY_3, IMMEDIATE_POSTOP_COMP_1, IMMEDIATE_POSTOP_COMP_2, IMMEDIATE_POSTOP_COMP_3, IMMEDIATE_POSTOP_COMP_5, BLEEDING_MGT, ISCHEMIC_STEAL_MGT, THROMBOSIS_MGT_2, THROMBOSIS_MGT_3, THROMBOSIS_MGT_4, THROMBOSIS_MGT_5, TOTAL_LOS, NON_HOME_DC, ANY_CHANGE_MEDICATION, DC_ASA, DC_P2Y, DC_STATIN, DC_ANTICOAG)

predictors_test_postop <- test %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW, ABX, ABX_START, ABX_STOP, ANESTHESIA, TARGET_ARTERY_DIAMETER, TARGET_VEIN_DIAMETER, CCPROC_0, CCPROC_1, CCPROC_2, CCPROC_3, CCPROC_4, CCPROC_5, CCPROC_6, CCPROC_7, CCPROC_8, CCPROC_9, CCPROC_10, CCPROC_99, R_COMPLETION_STUDY_0, R_COMPLETION_STUDY_1, R_COMPLETION_STUDY_2, R_COMPLETION_STUDY_3, IMMEDIATE_POSTOP_COMP_1, IMMEDIATE_POSTOP_COMP_2, IMMEDIATE_POSTOP_COMP_3, IMMEDIATE_POSTOP_COMP_5, BLEEDING_MGT, ISCHEMIC_STEAL_MGT, THROMBOSIS_MGT_2, THROMBOSIS_MGT_3, THROMBOSIS_MGT_4, THROMBOSIS_MGT_5, TOTAL_LOS, NON_HOME_DC, ANY_CHANGE_MEDICATION, DC_ASA, DC_P2Y, DC_STATIN, DC_ANTICOAG)

#Train pre-op models
library(caret)
library(xgboost)
library(ranger)
library(naivebayes)
library(e1071)
library(nnet)
train_control <- trainControl(method = "cv", number = 10) #10-fold cross-validation

#Train XGBoost
XGBgrid <- expand.grid(max_depth = c(2,3,4,5,6,7,8,9), nrounds = (1:10)*50, eta = c(0.4,0.3,0.2,0.1,0.05,0.01,0.001), gamma = c(0,0.1,1,1.5,2), subsample = c(0.5,0.6,0.7,0.8,0.9,1), min_child_weight = c(1,3,5,7,10), colsample_bytree = c(0.5,0.6,0.7,0.8,0.9,1) #XGBoost grid search for hyperparameters
XGB <- train(x = as.matrix(predictors_train_preop), y = train$ACCESS_USED, data = train, method = "xgbTree", metric = "ROC", trControl = train_control, tuneGrid = XGBgrid)

#Train random forest
RFgrid <- expand.grid(mtry = 2:4, splitrule = "gini", min.node.size = c(10,20))
RF <- train(x = predictors_train_preop, y = train$ACCESS_USED, data = train, method = "ranger", metric = "ROC", trControl = train_control, tuneGrid = RFgrid)

#Train naive bayes
NBgrid <- expand.grid(usekernel = c(TRUE, FALSE), fL = 0:5, adjust = seq(0,5,by=1))
NB <- train(x = predictors_train_preop, y = as.factor(train$ACCESS_USED), data = train, method = "naive_bayes", metric = "ROC", trControl = train_control, tuneGrid = NBgrid)

#Train support vector machine
SVMgrid <- expand.grid(C = c(0.001, 0.01, 0.1, 1, 10, 100, 10000))
SVM <- train(x = predictors_train_preop, y = train$ACCESS_USED, data = train, method = "svmRadial", metric = "ROC", trControl = train_control, tuneGrid = SVMgrid)

#Train artificial neural network
NNETgrid <- expand.grid(size = seq(1,10,by=1), decay = seq(0.1,0.5,by=0.1))
NNET <- train(x = predictors_train_preop, y = train$ACCESS_USED, data = train, method = "nnet", metric = "ROC", trControl = train_control, tuneGrid = NNETgrid)

#Train logistic regression
LRgrid <- expand.grid(C = c(0.001, 0.01, 0.1, 1, 10, 100, 10000))
LR <- train(x = predictors_train_preop, y = train$ACCESS_USED, data = train, method = "glm", metric = "ROC", trControl = train_control, tuneGrid = LRgrid, family = "binomial")

#Evaluate pre-op models on test set
library(pROC)

XGB_pred <- predict(XGB, as.matrix(predictors_test_preop))
auc(test$ACCESS_USED, XGB_pred)
ci.auc(test$ACCESS_USED, XGB_pred)
XGB_pred_0.5 <- ifelse(XGB_pred > 0.5,1,0)
confusionMatrix(as.factor(test$ACCESS_USED), as.factor(XGB_pred_0.5))

RF_pred <- predict(RF, predictors_test_preop)
auc(test$ACCESS_USED, RF_pred$predictions)
ci.auc(test$ACCESS_USED, RF_pred$predictions)
RF_pred_0.5 <- ifelse(RF_pred$predictions > 0.5,1,0)
confusionMatrix(as.factor(test$ACCESS_USED), as.factor(RF_pred_0.5))

NB_pred <- predict(NB, predictors_test_preop)
auc(test$ACCESS_USED, NB_pred)
ci.auc(test$ACCESS_USED, NB_pred)
NB_pred_0.5 <- ifelse(NB_pred > 0.5,1,0)
confusionMatrix(as.factor(test$ACCESS_USED), as.factor(NB_pred_0.5))

SVM_pred <- predict(SVM, predictors_test_preop)
auc(test$ACCESS_USED, SVM_pred)
ci.auc(test$ACCESS_USED, SVM_pred)
SVM_pred_0.5 <- ifelse(SVM_pred > 0.5,1,0)
confusionMatrix(as.factor(test$ACCESS_USED), as.factor(SVM_pred_0.5))

NNET_pred <- predict(NNET, predictors_test_preop)
auc(test$ACCESS_USED, NNET_pred)
ci.auc(test$ACCESS_USED, NNET_pred)
NNET_pred_0.5 <- ifelse(NNET_pred > 0.5,1,0)
confusionMatrix(as.factor(test$ACCESS_USED), as.factor(NNET_pred_0.5))

LR_pred <- predict(LR, predictors_test_preop)
auc(test$ACCESS_USED, LR_pred)
ci.auc(test$ACCESS_USED, LR_pred)
LR_pred_0.5 <- ifelse(LR_pred > 0.5,1,0)
confusionMatrix(as.factor(test$ACCESS_USED), as.factor(LR_pred_0.5))

#XGBoost selected as best performing model
#Train XGBoost on intra-operative and post-operative data
XGB_preop <- XGB
XGB_intraop <- train(x = as.matrix(predictors_train_intraop), y = train$ACCESS_USED, data = train, method = "xgbTree", metric = "ROC", trControl = train_control, tuneGrid = XGBgrid)
XGB_postop <- train(x = as.matrix(predictors_train_postop), y = train$ACCESS_USED, data = train, method = "xgbTree", metric = "ROC", trControl = train_control, tuneGrid = XGBgrid)

#Generate ROC curves
library(ROCR)
XGB_preop_pred <- predict(XGB_preop, as.matrix(predictors_test_preop))
XGB_preop_perf <- prediction(XGB_preop_pred, test$ACCESS_USED)
XGB_preop_perf <- performance(XGB_preop_perf, "tpr", "fpr")

XGB_intraop_pred <- predict(XGB_intraop, as.matrix(predictors_test_intraop))
XGB_intraop_perf <- prediction(XGB_intraop_pred, test$ACCESS_USED)
XGB_intraop_perf <- performance(XGB_intraop_perf, "tpr", "fpr")

XGB_postop_pred <- predict(XGB_postop, as.matrix(predictors_test_postop))
XGB_postop_perf <- prediction(XGB_postop_pred, test$ACCESS_USED)
XGB_postop_perf <- performance(XGB_postop_perf, "tpr", "fpr")

plot(XGB_preop_perf)
plot(XGB_intraop_perf, add = TRUE, col = 'blue')
plot(XGB_postop_perf, add = TRUE, col = 'orange')
abline(a=0,b=1)

#Generate calibration plots
library(gbm)
calibrate.plot(test$ACCESS_USED, XGB_preop_pred)
calibrate.plot(test$ACCESS_USED, XGB_intraop_pred)
calibrate.plot(test$ACCESS_USED, XGB_postop_pred)

#Calculate Brier Scores
library(DescTools)
BrierScore(XGB_preop_pred, test$ACCESS_USED)
BrierScore(XGB_intraop_pred, test$ACCESS_USED)
BrierScore(XGB_postop_pred, test$ACCESS_USED)

#Calculate variable importance scores for top 10 predictors
importance_matrix <- xgb.importance(names(predictors_test_postop), model = XGB_postop)
xgb.plot.importance(importance_matrix, top_n = 10)

#Subgroup analysis based on age
test_under60 <- test[test$AGE<60, ]
test_over60 <- test[test$AGE>=60, ]
predictors_test_under60 <- test_under60 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_over60 <- test_over60 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_under60 <- predict(XGB_preop, as.matrix(predictors_test_under60))
auc(test_under70$ACCESS_USED, pred_under60)
ci.auc(test_under60$ACCESS_USED, pred_under60)

pred_over60 <- predict(XGB_preop, as.matrix(predictors_test_over60))
auc(test_over60$ACCESS_USED, pred_over60)
ci.auc(test_over60$ACCESS_USED, pred_over60)

perf_under60 <- prediction(pred_under60, test_under60$ACCESS_USED)
perf_under60 <- performance(perf_under60, "tpr", "fpr")

perf_over60 <- prediction(pred_over60, test_over60$ACCESS_USED)
perf_over60 <- performance(perf_over60, "tpr", "fpr")

plot(perf_under60)
plot(perf_over60, add = TRUE, col = 'blue')
abline(a=0,b=1)

#Subgroup analysis based on sex
test_male <- test[test$GENDER==1, ]
test_female <- test[test$GENDER==2, ]
predictors_test_male <- test_male %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_female <- test_female %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_male <- predict(XGB_preop, as.matrix(predictors_test_male))
auc(test_male$ACCESS_USED, pred_male)
ci.auc(test_male$ACCESS_USED, pred_male)

pred_female <- predict(XGB_preop, as.matrix(predictors_test_female))
auc(test_female$ACCESS_USED, pred_female)
ci.auc(test_female$ACCESS_USED, pred_female)

perf_male <- prediction(pred_male, test_male$ACCESS_USED)
perf_male <- performance(perf_male, "tpr", "fpr")

perf_female <- prediction(pred_female, test_female$ACCESS_USED)
perf_female <- performance(perf_female, "tpr", "fpr")

plot(perf_male)
plot(perf_female, add = TRUE, col = 'blue')
abline(a=0,b=1)

#Subgroup analysis based on race
test_white <- test[test$RACE==5, ]
test_nonwhite <- test[test$RACE!=5, ]
predictors_test_white <- test_white %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_nonwhite <- test_nonwhite %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_white <- predict(XGB_preop, as.matrix(predictors_test_white))
auc(test_white$ACCESS_USED, pred_white)
ci.auc(test_white$ACCESS_USED, pred_white)

pred_nonwhite <- predict(XGB_preop, as.matrix(predictors_test_nonwhite))
auc(test_nonwhite$ACCESS_USED, pred_nonwhite)
ci.auc(test_nonwhite$ACCESS_USED, pred_nonwhite)

perf_white <- prediction(pred_white, test_white$ACCESS_USED)
perf_white <- performance(perf_white, "tpr", "fpr")

perf_nonwhite <- prediction(pred_nonwhite, test_nonwhite$ACCESS_USED)
perf_nonwhite <- performance(perf_nonwhite, "tpr", "fpr")

plot(perf_white)
plot(perf_nonwhite, add = TRUE, col = 'blue')
abline(a=0,b=1)

#Subgroup analysis based on ethnicity
test_hispanic <- test[test$ETHNICITY==1, ]
test_nonhispanic <- test[test$ETHNICITY==0, ]
predictors_test_hispanic <- test_hispanic %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_nonhispanic <- test_nonhispanic %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_hispanic <- predict(XGB_preop, as.matrix(predictors_test_hispanic))
auc(test_hispanic$ACCESS_USED, pred_hispanic)
ci.auc(test_hispanic$ACCESS_USED, pred_hispanic)

pred_nonhispanic <- predict(XGB_preop, as.matrix(predictors_test_nonhispanic))
auc(test_nonhispanic$ACCESS_USED, pred_nonhispanic)
ci.auc(test_nonhispanic$ACCESS_USED, pred_nonhispanic)

perf_hispanic <- prediction(pred_hispanic, test_hispanic$ACCESS_USED)
perf_hispanic <- performance(perf_hispanic, "tpr", "fpr")

perf_nonhispanic <- prediction(pred_nonhispanic, test_nonhispanic$ACCESS_USED)
perf_nonhispanic <- performance(perf_nonhispanic, "tpr", "fpr")

plot(perf_hispanic)
plot(perf_nonhispanic, add = TRUE, col = 'blue')
abline(a=0,b=1)

#Subgroup analysis based on rurality
test_rural <- test[test$RURAL==1, ]
test_nonrural <- test[test$RURAL==0, ]
predictors_test_rural <- test_rural %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_nonrural <- test_nonrural %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_rural <- predict(XGB_preop, as.matrix(predictors_test_rural))
auc(test_rural$ACCESS_USED, pred_rural)
ci.auc(test_rural$ACCESS_USED, pred_rural)

pred_nonrural <- predict(XGB_preop, as.matrix(predictors_test_nonrural))
auc(test_nonrural$ACCESS_USED, pred_nonrural)
ci.auc(test_nonrural$ACCESS_USED, pred_nonrural)

perf_rural <- prediction(pred_rural, test_rural$ACCESS_USED)
perf_rural <- performance(perf_rural, "tpr", "fpr")

perf_nonrural <- prediction(pred_nonrural, test_nonrural$ACCESS_USED)
perf_nonrural <- performance(perf_nonrural, "tpr", "fpr")

plot(perf_rural)
plot(perf_nonrural, add = TRUE, col = 'blue')
abline(a=0,b=1)

#Subgroup analysis based on median Area Deprivation Index (ADI) percentile
test_ADIover50 <- test[test$ADI_NATRANK_MEDIAN>=50, ]
test_ADIunder50 <- test[test$ADI_NATRANK_MEDIAN<50, ]
predictors_test_ADIover50 <- test_ADIover50 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_ADIunder50 <- test_ADIunder50 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_ADIover50 <- predict(XGB_preop, as.matrix(predictors_test_ADIover50))
auc(test_ADIover50$ACCESS_USED, pred_ADIover50)
ci.auc(test_ADIover50$ACCESS_USED, pred_ADIover50)

pred_ADIunder50 <- predict(XGB_preop, as.matrix(predictors_test_ADIunder50))
auc(test_ADIunder50$ACCESS_USED, pred_ADIunder50)
ci.auc(test_ADIunder50$ACCESS_USED, pred_ADIunder50)

perf_ADIover50 <- prediction(pred_ADIover50, test_ADIover50$ACCESS_USED)
perf_ADIover50 <- performance(perf_ADIover50, "tpr", "fpr")

perf_ADIunder50 <- prediction(pred_ADIunder50, test_ADIunder50$ACCESS_USED)
perf_ADIunder50 <- performance(perf_ADIunder50, "tpr", "fpr")

plot(perf_ADIover50)
plot(perf_ADIunder50, add = TRUE, col = 'blue')
abline(a=0,b=1)

#Subgroup analysis based on access type
test_avf <- test[test$ACCESSTYPE==1, ]
test_avg <- test[test$ACCESSTYPE>1, ]
predictors_test_avf <- test_avf %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_avg <- test_avg %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_avf <- predict(XGB_preop, as.matrix(predictors_test_avf))
auc(test_avf$ACCESS_USED, pred_avf)
ci.auc(test_avf$ACCESS_USED, pred_avf)

pred_avg <- predict(XGB_preop, as.matrix(predictors_test_avg))
auc(test_avg$ACCESS_USED, pred_avg)
ci.auc(test_avg$ACCESS_USED, pred_avg)

perf_avf <- prediction(pred_avf, test_avf$ACCESS_USED)
perf_avf <- performance(perf_avf, "tpr", "fpr")

perf_avg <- prediction(pred_avg, test_avg$ACCESS_USED)
perf_avg <- performance(perf_avg, "tpr", "fpr")

plot(perf_avf)
plot(perf_avg, add = TRUE, col = 'blue')
abline(a=0,b=1)

#Subgroup analysis based on access location
test_1 <- test[test$OUTFLOW_VEIN_ALL==1 | test$OUTFLOW_VEIN_ALL=3, ]
test_2 <- test[test$OUTFLOW_VEIN_ALL==2 | test$OUTFLOW_VEIN_ALL=4 | test$OUTFLOW_VEIN_ALL=5 | test$OUTFLOW_VEIN_ALL=6, ]
test_3 <- test[test$OUTFLOW_VEIN_ALL==7 | test$OUTFLOW_VEIN_ALL=8, ]
test_4 <- test[test$OUTFLOW_VEIN_ALL==99, ]
predictors_test_1 <- test_1 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_2 <- test_2 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_3 <- test_3 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)
predictors_test_4 <- test_4 %>% select(REGIONID, CENTERID, PHYSICIANID, SURGYEAR, SURGMONTH, SURGWEEKDAY, AGE, GENDER, BMI, RACE, ETHNICITY, PRIMARYINSURER, RURAL, ADI_NATRANK_MEDIAN, PERF_SITE, TRANSFER, HTN, PREOP_DIABETES, PREOP_SMOKING, PRIOR_CAD, PRIOR_CHF, PREOP_DYSRHYTHMIA, COPD, PAD, PRIOR_CABG, PRIOR_PCI, IVDRUGUSE, R_HIVSTATUS, CKD, ESRD, ASACLASS, LIVINGSTATUS, R_PREOP_AMBUL, HEMO_L, PREOP_CREAT_UMOL, GFR, PREOP_ASA, PREOP_P2Y, PREOP_STATIN, PREOP_ANTICOAG, CURRENT_ACCESS, PREVIOUS_ACCESS_EXIST, PREVIOUS_ACCESS_NUM, R_PRIOR_FISTULAS, R_PRIOR_GRAFTS, R_FOREARMFISTULA, R_FOREARMGRAFT, R_UPPERARMFISTULA, R_UPPERARMGRAFT, R_TUNCATHARM, R_AVACCESS_LEG, R_AVACCESS_OTHER, SIDE_PREV_ACCESS_1, SIDE_PREV_ACCESS_2, SIDE_PREV_ACCESS_3, SIDE_PREV_ACCESS_4, TYPE_PREV_ACCESS_1, TYPE_PREV_ACCESS_2, TYPE_PREV_ACCESS_3, TYPE_PREV_ACCESS_4, ACCESS_LOCATION_ALL_1, ACCESS_LOCATION_ALL_2, ACCESS_LOCATION_ALL_3, ACCESS_LOCATION_ALL_4, CENTRAL_VENOUS_DIALYSIS_0, CENTRAL_VENOUS_DIALYSIS_1, CENTRAL_VENOUS_DIALYSIS_2, CENTRAL_VENOUS_DIALYSIS_3, CENTRAL_VENOUS_DIALYSIS_4, OTHER_CATH_DEVICES, OTHER_CENTRAL_VENOUS_DEV_0, OTHER_CENTRAL_VENOUS_DEV_1, OTHER_CENTRAL_VENOUS_DEV_2, OTHER_CENTRAL_VENOUS_DEV_3, OTHER_CENTRAL_VENOUS_DEV_4, PREV_PICC_R, PREV_SUBQ_PORT_R, PREV_CARD_RHYTHM_R, PREV_PICC_L, PREV_SUBQ_PORT_L, PREV_CARD_RHYTHM_L, CUR_PICC_R, CUR_CARD_RHYTHM_R, CUR_PICC_L, CUR_SUBQ_PORT_L, CUR_CARD_RHYTHM_L, LOWER_EXTREM_TUN_CATH_NONE, LOWER_EXTREM_TUN_CATH_PREV_R, LOWER_EXTREM_TUN_CATH_PREV_L, LOWER_EXTREM_TUN_CATH_CURR_R, LOWER_EXTREM_TUN_CATH_CURR_L, OTH_ACCESS_NONE, OTH_ACCESS_TRANSPHEPATIC_CATH, OTH_ACCESS_TRANSLUMBAR_CATH, OTH_ACCESS_AXILLARY_GRAFT, OTHER_ACCESS_OTHER, IMAGING_0, IMAGING_1, IMAGING_2, IMAGING_3, IMAGING_4, PREOP_ARTERY_DIAMETER, PREOP_VEIN_DIAMETER, SIDE, ACCESSTYPE, INFLOW_ARTERY, OUTFLOW_VEIN_ALL, PLANNED2STAGE_NEW, R_BASVEINTRANSPO, ARTINTERV_NEW, VENINTERV_NEW)

pred_1 <- predict(XGB_preop, as.matrix(predictors_test_1))
auc(test_1$ACCESS_USED, pred_1)
ci.auc(test_1$ACCESS_USED, pred_1)

pred_2 <- predict(XGB_preop, as.matrix(predictors_test_2))
auc(test_2$ACCESS_USED, pred_2)
ci.auc(test_2$ACCESS_USED, pred_2)

pred_3 <- predict(XGB_preop, as.matrix(predictors_test_3))
auc(test_3$ACCESS_USED, pred_3)
ci.auc(test_3$ACCESS_USED, pred_3)

pred_4 <- predict(XGB_preop, as.matrix(predictors_test_4))
auc(test_4$ACCESS_USED, pred_4)
ci.auc(test_4$ACCESS_USED, pred_4)

perf_1 <- prediction(pred_1, test_1$ACCESS_USED)
perf_1 <- performance(perf_1, "tpr", "fpr")

perf_2 <- prediction(pred_2, test_2$ACCESS_USED)
perf_2 <- performance(perf_2, "tpr", "fpr")

perf_3 <- prediction(pred_3, test_3$ACCESS_USED)
perf_3 <- performance(perf_3, "tpr", "fpr")

perf_4 <- prediction(pred_4, test_4$ACCESS_USED)
perf_4 <- performance(perf_4, "tpr", "fpr")

plot(perf_1)
plot(perf_2, add = TRUE, col = 'blue')
plot(perf_3, add = TRUE, col = 'orange')
plot(perf_4, add = TRUE, col = 'green')
abline(a=0,b=1)

#Train and evaluate XGBoost for predicting secondary outcomes

XGB_thromb_preop <- xgboost(data = as.matrix(predictors_train_preop), label = as.numeric(train$LTF_ACCESS_THROMBOSED), nrounds = 200, verbose = TRUE, objective = 'binary:logistic', eval_metric = 'auc', max_depth = 4, eta = 0.05, gamma = 0, colsample_bytree = 0.8, min_child_weight = 1, subsample = 1) #hyperparameters chosen based on above grid search and cross validation
XGB_thromb_pred_preop <- predict(XGB_thromb_preop, as.matrix(predictors_test_preop))
auc(test$LTF_ACCESS_THROMBOSED, XGB_thromb_pred_preop)
ci.auc(test$LTF_ACCESS_THROMBOSED, XGB_thromb_pred_preop)
XGB_thromb_pred_preop_0.5 <- ifelse(XGB_thromb_pred_preop > 0.5,1,0)
confusionMatrix(as.factor(test$LTF_ACCESS_THROMBOSED), as.factor(XGB_thromb_pred_preop_0.5))

XGB_thromb_intraop <- xgboost(data = as.matrix(predictors_train_intraop), label = as.numeric(train$LTF_ACCESS_THROMBOSED), nrounds = 200, verbose = TRUE, objective = 'binary:logistic', eval_metric = 'auc', max_depth = 4, eta = 0.05, gamma = 0, colsample_bytree = 0.8, min_child_weight = 1, subsample = 1)
XGB_thromb_pred_intraop <- predict(XGB_thromb_intraop, as.matrix(predictors_test_intraop))
auc(test$LTF_ACCESS_THROMBOSED, XGB_thromb_pred_intraop)
ci.auc(test$LTF_ACCESS_THROMBOSED, XGB_thromb_pred_intraop)
XGB_thromb_pred_intraop_0.5 <- ifelse(XGB_thromb_pred_intraop > 0.5,1,0)
confusionMatrix(as.factor(test$LTF_ACCESS_THROMBOSED), as.factor(XGB_thromb_pred_intraop_0.5))

XGB_thromb_postop <- xgboost(data = as.matrix(predictors_train_postop), label = as.numeric(train$LTF_ACCESS_THROMBOSED), nrounds = 200, verbose = TRUE, objective = 'binary:logistic', eval_metric = 'auc', max_depth = 4, eta = 0.05, gamma = 0, colsample_bytree = 0.8, min_child_weight = 1, subsample = 1)
XGB_thromb_pred_postop <- predict(XGB_thromb_postop, as.matrix(predictors_test_postop))
auc(test$LTF_ACCESS_THROMBOSED, XGB_thromb_pred_postop)
ci.auc(test$LTF_ACCESS_THROMBOSED, XGB_thromb_pred_postop)
XGB_thromb_pred_postop_0.5 <- ifelse(XGB_thromb_pred_postop > 0.5,1,0)
confusionMatrix(as.factor(test$LTF_ACCESS_THROMBOSED), as.factor(XGB_thromb_pred_postop_0.5))

XGB_reint_preop <- xgboost(data = as.matrix(predictors_train_preop), label = as.numeric(train$LTF_POST_PROC_INTERVENTION), nrounds = 200, verbose = TRUE, objective = 'binary:logistic', eval_metric = 'auc', max_depth = 4, eta = 0.05, gamma = 0, colsample_bytree = 0.8, min_child_weight = 1, subsample = 1)
XGB_reint_pred_preop <- predict(XGB_reint_preop, as.matrix(predictors_test_preop))
auc(test$LTF_POST_PROC_INTERVENTION, XGB_reint_pred_preop)
ci.auc(test$LTF_POST_PROC_INTERVENTION, XGB_reint_pred_preop)
XGB_reint_pred_preop_0.5 <- ifelse(XGB_reint_pred_preop > 0.5,1,0)
confusionMatrix(as.factor(test$LTF_POST_PROC_INTERVENTION), as.factor(XGB_reint_pred_preop_0.5))

XGB_reint_intraop <- xgboost(data = as.matrix(predictors_train_intraop), label = as.numeric(train$LTF_POST_PROC_INTERVENTION), nrounds = 200, verbose = TRUE, objective = 'binary:logistic', eval_metric = 'auc', max_depth = 4, eta = 0.05, gamma = 0, colsample_bytree = 0.8, min_child_weight = 1, subsample = 1)
XGB_reint_pred_intraop <- predict(XGB_reint_intraop, as.matrix(predictors_test_intraop))
auc(test$LTF_POST_PROC_INTERVENTION, XGB_reint_pred_intraop)
ci.auc(test$LTF_POST_PROC_INTERVENTION, XGB_reint_pred_intraop)
XGB_reint_pred_intraop_0.5 <- ifelse(XGB_reint_pred_intraop > 0.5,1,0)
confusionMatrix(as.factor(test$LTF_POST_PROC_INTERVENTION), as.factor(XGB_reint_pred_intraop_0.5))

XGB_reint_postop <- xgboost(data = as.matrix(predictors_train_postop), label = as.numeric(train$LTF_POST_PROC_INTERVENTION), nrounds = 200, verbose = TRUE, objective = 'binary:logistic', eval_metric = 'auc', max_depth = 4, eta = 0.05, gamma = 0, colsample_bytree = 0.8, min_child_weight = 1, subsample = 1)
XGB_reint_pred_postop <- predict(XGB_reint_postop, as.matrix(predictors_test_postop))
auc(test$LTF_POST_PROC_INTERVENTION, XGB_reint_pred_postop)
ci.auc(test$LTF_POST_PROC_INTERVENTION, XGB_reint_pred_postop)
XGB_reint_pred_postop_0.5 <- ifelse(XGB_reint_pred_postop > 0.5,1,0)
confusionMatrix(as.factor(test$LTF_POST_PROC_INTERVENTION), as.factor(XGB_reint_pred_postop_0.5))
